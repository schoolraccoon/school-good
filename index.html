<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„ ìƒë‹˜ ë¶€ì¬ì¤‘ í™•ì¸ ì‹œìŠ¤í…œ - ì‹¤ì‹œê°„ ë™ê¸°í™” (Firebase)</title>

    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ì„ ìƒë‹˜ ë¶€ì¬ì¤‘ í™•ì¸">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%E2%9C%8F%EF%B8%8F%3C/text%3E%3C/svg%3E">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3E%E2%9C%8F%EF%B8%8F%3C/text%3E%3C/svg%3E">

    <style>
        /* ê¸°ì¡´ CSSëŠ” ìœ ì§€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #dbeafe 100%); min-height: 100vh; padding: 1rem; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .header h1 { font-size: 2.5rem; color: #1f2937; margin-bottom: 0.5rem; }
        .header p { color: #6b7280; font-size: 1rem; }
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; }
        .btn-primary { background: #4f46e5; color: white; }
        .btn-primary:hover { background: #4338ca; }
        .btn-outline { background: transparent; border: 2px solid #d1d5db; color: #374151; }
        .btn-outline:hover { background: #f9fafb; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 1rem; }
        .stat-icon { width: 48px; height: 48px; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .stat-count { font-size: 2rem; font-weight: bold; color: #1f2937; }
        .stat-label { font-size: 0.875rem; color: #6b7280; }
        .teachers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .teacher-card { background: rgba(255, 255, 255, 0.9); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        /* í•™ìƒì´ í´ë¦­í•  ìˆ˜ ìˆë„ë¡ ì»¤ì„œ ë³€ê²½ */
        .teacher-card:not(.logged-in-teacher):hover { cursor: pointer; transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }

        .teacher-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .teacher-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
        }
        .teacher-name { font-size: 1.25rem; font-weight: bold; color: #1f2937; }
        .teacher-subject { font-size: 0.875rem; color: #6b7280; }
        .status-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; border: 1px solid; }
        .status-office { background: #dcfce7; color: #166534; border-color: #bbf7d0; }
        .status-class { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; }
        .status-away { background: #fee2e2; color: #991b1b; border-color: #fecaca; }
        .status-not-school { background: #f3f4f6; color: #374151; border-color: #d1d5db; }
        .login-modal, .dashboard-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 2rem; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); width: 90%; max-width: 400px; }
        .modal-header { text-align: center; margin-bottom: 2rem; }
        .modal-icon { width: 64px; height: 64px; background: #e0e7ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: #4f46e5; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        .form-input { width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.5rem; font-size: 1rem; transition: border-color 0.3s ease; }
        .form-input:focus { outline: none; border-color: #4f46e5; }
        .error-message { background: #fee2e2; color: #991b1b; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1rem; font-size: 0.875rem; }
        .current-status { background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .status-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem; }
        .status-btn {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        .status-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        .status-btn:hover { background: #f9fafb; }
        .status-btn.active:hover { background: #4338ca; }
        .hidden { display: none; }
        @media (max-width: 768px) { .header h1 { font-size: 2rem; } .stats-grid { grid-template-columns: 1fr 1fr; } .teachers-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainDashboard">
            <div class="header">
                <div>
                    <h1>ì„ ìƒë‹˜ ë¶€ì¬ì¤‘ í™•ì¸</h1>
                    <p>ì‹¤ì‹œê°„ ì„ ìƒë‹˜ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì§ˆë¬¸ì„ ë‚¨ê¸°ì„¸ìš”</p>
                </div>
                <button class="btn btn-primary" id="loginButton">
                    ğŸ”‘ ì„ ìƒë‹˜ ë¡œê·¸ì¸
                </button>
            </div>

            <div class="stats-grid" id="statsGrid">
                </div>

            <div class="teachers-grid" id="teachersGrid">
                </div>
        </div>

        <div id="loginModal" class="login-modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon">ğŸ”‘</div>
                    <h2>ì„ ìƒë‹˜ ë¡œê·¸ì¸</h2>
                    <p>ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">ì´ë¦„</label>
                        <input type="text" class="form-input" id="loginName" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-input" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                    </div>
                    <div id="loginError" class="error-message hidden"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">ë¡œê·¸ì¸</button>
                        <button type="button" class="btn btn-outline" id="loginCancelBtn" style="flex: 1;">ëŒì•„ê°€ê¸°</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="teacherModal" class="dashboard-modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon">ğŸ”‘</div>
                    <h2 id="teacherName"></h2>
                    <p id="teacherSubject"></p>
                </div>

                <div class="current-status">
                    <label class="form-label">í˜„ì¬ ìƒíƒœ</label>
                    <div id="currentStatus" style="display: flex; align-items: center; gap: 0.5rem; font-weight: bold; font-size: 1.1rem;">
                    </div>
                </div>

                <div>
                    <label class="form-label">ìƒíƒœ ë³€ê²½</label>
                    <div class="status-buttons">
                        <button class="status-btn" data-status="êµë¬´ì‹¤ì— ìˆìŒ">
                            ğŸ  êµë¬´ì‹¤
                        </button>
                        <button class="status-btn" data-status="ìˆ˜ì—… ì¤‘">
                            ğŸ“š ìˆ˜ì—… ì¤‘
                        </button>
                        <button class="status-btn" data-status="ë¶€ì¬ì¤‘">
                            âŒ ë¶€ì¬ì¤‘
                        </button>
                        <button class="status-btn" data-status="í•™êµì— ì—†ìŒ">
                            ğŸšª í•™êµì— ì—†ìŒ
                        </button>
                    </div>
                </div>

                <button class="btn btn-outline" id="openQAModalBtn" style="width: 100%; margin-top: 1rem;">
                    ğŸ’¬ ì§ˆë¬¸ ë‹µë³€ ê´€ë¦¬
                </button>
                <button class="btn btn-danger" id="logoutBtn" style="width: 100%; margin-top: 0.5rem;">
                    ğŸšª ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>

        <div id="studentQuestionModal" class="dashboard-modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon">â“</div>
                    <h2 id="questionTeacherName"></h2>
                    <p>ì„ ìƒë‹˜ê»˜ ì§ˆë¬¸ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.</p>
                </div>
                <form id="questionForm">
                    <div class="form-group">
                        <label class="form-label">í•™ë²ˆ</label>
                        <input type="text" class="form-input" id="studentId" placeholder="í•™ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì´ë¦„</label>
                        <input type="text" class="form-input" id="studentName" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì§ˆë¬¸ ë‚´ìš©</label>
                        <textarea class="form-input" id="questionText" rows="5" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required></textarea>
                    </div>
                    <div id="questionError" class="error-message hidden"></div>
                    <div style="display: flex; gap: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">ì§ˆë¬¸ ì œì¶œ</button>
                        <button type="button" class="btn btn-outline" id="questionCancelBtn" style="flex: 1;">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="teacherQAModal" class="dashboard-modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-icon">ğŸ’¬</div>
                    <h2 id="qaTeacherName"></h2>
                    <p>í•™ìƒë“¤ì˜ ì§ˆë¬¸ì— ë‹µí•˜ì„¸ìš”.</p>
                </div>

                <div id="teacherQuestionsList" class="current-status" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #6b7280;">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>

                <button class="btn btn-outline" id="closeQAModalBtn" style="width: 100%; margin-top: 1rem;">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Firebase SDK ì´ˆê¸°í™” ë¶€ë¶„ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

        // Firebase Configuration (ë³¸ì¸ì˜ Firebase í”„ë¡œì íŠ¸ ì„¤ì •ìœ¼ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤.)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // â­ ì—¬ê¸°ì— ì‹¤ì œ Firebase API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
            measurementId: "YOUR_MEASUREMENT_ID"
        };

        // Firebase ì•±ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        const app = initializeApp(firebaseConfig);
        // Realtime Database ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        const database = getDatabase(app);
        // Firebase Realtime Databaseì˜ 'teachers' ê²½ë¡œë¥¼ ì°¸ì¡°í•©ë‹ˆë‹¤.
        const teachersRef = ref(database, 'teachers');

        // --- ì„ ìƒë‹˜ í˜„í™©íŒ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ ì‹œì‘ ---

        let teachers = []; // Firebaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™€ ì €ì¥í•  ë°°ì—´
        let currentTeacher = null; // í˜„ì¬ ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì •ë³´

        // ìƒíƒœë³„ CSS í´ë˜ìŠ¤ì™€ ì•„ì´ì½˜ ì •ì˜
        const statusConfig = {
            "êµë¬´ì‹¤ì— ìˆìŒ": { class: "status-office", icon: "ğŸ " },
            "ë¶€ì¬ì¤‘": { class: "status-away", icon: "âŒ" },
            "ìˆ˜ì—… ì¤‘": { class: "status-class", icon: "ğŸ“š" },
            "í•™êµì— ì—†ìŒ": { class: "status-not-school", icon: "ğŸšª" }
        };

        // ê³¼ëª©ë³„ ì•„ì´ì½˜ ì •ì˜ (ìˆ˜í•™ì€ '+'ë¡œ ë³€ê²½)
        const subjectIcons = {
            "ìˆ˜í•™": "â•",
            "ë¬¼ë¦¬": "âš›ï¸",
            "ì‚¬íšŒ": "ğŸ›ï¸",
            "ì—­ì‚¬": "ğŸ“œ",
            "ìƒëª…": "ğŸŒ±",
            "êµ­ì–´": "ğŸ“–",
            "ì˜ì–´": "ğŸ”¤"
        };

        // í•™ìƒì´ ì§ˆë¬¸í•˜ê¸° ìœ„í•´ ì„ íƒí•œ ì„ ìƒë‹˜ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ” ì „ì—­ ë³€ìˆ˜
        let selectedTeacherForQuestion = null;

        /**
         * Realtime Databaseì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³ , UIë¥¼ ë Œë”ë§í•˜ëŠ” ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
         * ë°ì´í„°ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì´ í•¨ìˆ˜ê°€ í˜¸ì¶œë˜ì–´ UIë¥¼ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.
         */
        function initializeFirebaseDataListener() {
            onValue(teachersRef, (snapshot) => {
                const data = snapshot.val(); // Firebaseì—ì„œ í˜„ì¬ ìŠ¤ëƒ…ìƒ·ì˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°

                if (!data) {
                    console.log("Firebaseì— ë°ì´í„°ê°€ ì—†ì–´ ì´ˆê¸° ë°ì´í„° ì„¤ì • ì¤‘...");
                    const defaultTeachers = [
                        { name: "ì´ëª…ìš©T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ìˆ˜í•™", messages: [] },
                        { name: "ì •í‰ê°•T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ë¬¼ë¦¬", messages: [] },
                        { name: "ì¡°í˜•ì¼T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ì‚¬íšŒ", messages: [] },
                        { name: "ê¹€ì„±í˜„T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ì—­ì‚¬", messages: [] },
                        { name: "ë°•ìƒí¬T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ìƒëª…", messages: [] },
                        { name: "ì´ì†Œë¼T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "êµ­ì–´", messages: [] },
                        { name: "ì„œí˜ì§„T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ìˆ˜í•™", messages: [] },
                        { name: "ì¥ê±´ê¸°T", status: "êµë¬´ì‹¤ì— ìˆìŒ", password: "0101", subject: "ì˜ì–´", messages: [] },
                    ];
                    // Firebaseì— ì´ˆê¸° ë°ì´í„°ë¥¼ í•œ ë²ˆë§Œ ì €ì¥(ë®ì–´ì“°ê¸°)
                    set(teachersRef, defaultTeachers)
                        .then(() => console.log("ì´ˆê¸° ë°ì´í„° Firebaseì— ì €ì¥ ì™„ë£Œ"))
                        .catch((error) => console.error("ì´ˆê¸° ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:", error));
                    teachers = defaultTeachers; // ì´ˆê¸° ë°ì´í„°ë¡œ í˜„ì¬ teachers ë°°ì—´ ì—…ë°ì´íŠ¸
                } else {
                    // ë°ì´í„°ê°€ ìˆìœ¼ë©´ teachers ë°°ì—´ ì—…ë°ì´íŠ¸
                    // Firebase ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹Œ ê°ì²´ë¡œ ì˜¬ ê²½ìš°ë¥¼ ëŒ€ë¹„í•˜ì—¬ ì²˜ë¦¬
                    if (Array.isArray(data)) {
                        teachers = data;
                    } else {
                        // ê°ì²´ í˜•íƒœì˜ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜ (ì˜ˆ: {0: {..}, 1: {..}})
                        teachers = Object.values(data);
                    }

                    // ëª¨ë“  ì„ ìƒë‹˜ ê°ì²´ì— messages ë°°ì—´ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
                    teachers.forEach(t => {
                        if (!t.messages) {
                            t.messages = [];
                        }
                    });
                }

                console.log("Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¨ teachers ë°ì´í„°:", teachers); // â­ ë°ì´í„° ë¡œë“œ í™•ì¸ìš© ë¡œê·¸

                // UI ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
                renderStats();
                renderTeachers();

                // ë§Œì•½ í˜„ì¬ ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì´ ìˆë‹¤ë©´, ê·¸ ì„ ìƒë‹˜ì˜ ëŒ€ì‹œë³´ë“œ ë° Q&A ëª¨ë‹¬ë„ ì—…ë°ì´íŠ¸
                if (currentTeacher) {
                    const updatedCurrentTeacher = teachers.find(t => t.name === currentTeacher.name);
                    if (updatedCurrentTeacher) {
                        currentTeacher = updatedCurrentTeacher; // í˜„ì¬ ì„ ìƒë‹˜ ì •ë³´ë„ ìµœì‹ ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                        updateCurrentStatusDisplay();
                        updateStatusButtons();
                        // ì„ ìƒë‹˜ Q&A ëª¨ë‹¬ì´ ì—´ë ¤ ìˆë‹¤ë©´, Q&A ëª©ë¡ë„ ì—…ë°ì´íŠ¸
                        if (!document.getElementById('teacherQAModal').classList.contains('hidden')) {
                            showTeacherQAModal(); // Q&A ëª¨ë‹¬ ì¬í˜¸ì¶œí•˜ì—¬ ëª©ë¡ ì—…ë°ì´íŠ¸
                        }
                    }
                }
                console.log("Firebase ë°ì´í„° ì—…ë°ì´íŠ¸ ê°ì§€ ë° UI ê°±ì‹  ì™„ë£Œ");
            }, (error) => {
                console.error("Firebase ë°ì´í„° ì½ê¸° ì˜¤ë¥˜:", error);
            });
        }

        /**
         * í˜„ì¬ ì„ ìƒë‹˜ ìƒíƒœë¥¼ ê¸°ë°˜ìœ¼ë¡œ í†µê³„ ì¹´ë“œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderStats() {
            const stats = {};
            teachers.forEach(teacher => {
                stats[teacher.status] = (stats[teacher.status] || 0) + 1;
            });

            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = ''; // ê¸°ì¡´ í†µê³„ ì¹´ë“œ ì§€ìš°ê¸°

            // ê° ìƒíƒœë³„ë¡œ í†µê³„ ì¹´ë“œ ìƒì„± ë° ì¶”ê°€
            Object.entries(statusConfig).forEach(([status, config]) => {
                const count = stats[status] || 0;
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <div class="stat-icon ${config.class}">
                        ${config.icon}
                    </div>
                    <div>
                        <div class="stat-count">${count}</div>
                        <div class="stat-label">${status}</div>
                    </div>
                `;
                statsGrid.appendChild(statCard);
            });
        }

        /**
         * ë©”ì¸ ëŒ€ì‹œë³´ë“œì— ê°œë³„ ì„ ìƒë‹˜ ì¹´ë“œë¥¼ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function renderTeachers() {
            const teachersGrid = document.getElementById('teachersGrid');
            teachersGrid.innerHTML = ''; // ê¸°ì¡´ ì„ ìƒë‹˜ ì¹´ë“œ ì§€ìš°ê¸°

            // ê° ì„ ìƒë‹˜ë³„ë¡œ ì¹´ë“œ ìƒì„± ë° ì¶”ê°€
            teachers.forEach(teacher => {
                const config = statusConfig[teacher.status];
                const teacherCard = document.createElement('div');
                teacherCard.className = 'teacher-card';
                // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì˜ ì¹´ë“œì—ëŠ” 'logged-in-teacher' í´ë˜ìŠ¤ ì¶”ê°€
                if (currentTeacher && currentTeacher.name === teacher.name) {
                    teacherCard.classList.add('logged-in-teacher');
                }

                // ê³¼ëª©ì— ë§ëŠ” ì•„ì´ì½˜ì„ ì°¾ì•„ ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ë³¸ ì—°í•„ ì•„ì´ì½˜
                const subjectIcon = subjectIcons[teacher.subject] || "âœï¸";
                teacherCard.innerHTML = `
                    <div class="teacher-header">
                        <div class="teacher-avatar">
                            ${subjectIcon}
                        </div>
                        <div>
                            <div class="teacher-name">${teacher.name}</div>
                            <div class="teacher-subject">${teacher.subject}</div>
                        </div>
                    </div>
                    <div class="status-badge ${config.class}">
                        ${config.icon} ${teacher.status}
                    </div>
                `;
                teachersGrid.appendChild(teacherCard);
            });
        }

        // --- ë¡œê·¸ì¸ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---

        /**
         * ë¡œê·¸ì¸ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginName').focus(); // ì´ë¦„ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            document.getElementById('loginError').classList.add('hidden'); // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('loginName').value = ''; // í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('loginPassword').value = ''; // í•„ë“œ ì´ˆê¸°í™”
            console.log("ë¡œê·¸ì¸ ë²„íŠ¼ì— í´ë¦­ ë¦¬ìŠ¤ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."); // í™•ì¸ìš© ë¡œê·¸
        }

        /**
         * ë¡œê·¸ì¸ ëª¨ë‹¬ì„ ìˆ¨ê¸°ê³  ì…ë ¥ í•„ë“œë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
         */
        function hideLogin() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginError').classList.add('hidden'); // ì˜¤ë¥˜ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            document.getElementById('loginName').value = '';
            document.getElementById('loginPassword').value = '';
        }

        /**
         * ë¡œê·¸ì¸ í¼ ì œì¶œì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
         * @param {Event} event - í¼ ì œì¶œ ì´ë²¤íŠ¸ ê°ì²´.
         */
        function handleLogin(event) {
            event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€
            const name = document.getElementById('loginName').value.toLowerCase().trim();
            const password = document.getElementById('loginPassword').value;

            // ì…ë ¥ëœ ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¡œ ì„ ìƒë‹˜ì„ ì°¾ìŠµë‹ˆë‹¤.
            const teacher = teachers.find(t => {
                const teacherName = t.name.toLowerCase();
                // 'T' ì ‘ë¯¸ì‚¬ ìœ ë¬´ì— ê´€ê³„ì—†ì´ ì´ë¦„ ë§¤ì¹­ì„ í—ˆìš©í•©ë‹ˆë‹¤. (ì˜ˆ: "ì´ëª…ìš©" ë˜ëŠ” "ì´ëª…ìš©t")
                const nameMatch = teacherName === name || teacherName.replace('t', '') === name;
                return nameMatch && t.password === password;
            });

            if (teacher) {
                currentTeacher = teacher; // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì •ë³´ ì €ì¥
                hideLogin(); // ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
                showTeacherDashboard(); // ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ í‘œì‹œ
                renderTeachers(); // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì¹´ë“œì— ìŠ¤íƒ€ì¼ ì ìš©ì„ ìœ„í•´ ë‹¤ì‹œ ë Œë”ë§
            } else {
                // ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
                const errorDiv = document.getElementById('loginError');
                errorDiv.textContent = 'ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                errorDiv.classList.remove('hidden');
            }
        }

        // --- ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---

        /**
         * ì„ ìƒë‹˜ ì „ìš© ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function showTeacherDashboard() {
            if (!currentTeacher) return; // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì´ ì—†ìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ

            document.getElementById('teacherName').textContent = currentTeacher.name + 'ë‹˜';
            document.getElementById('teacherSubject').textContent = currentTeacher.subject + ' ë‹´ë‹¹';
            updateCurrentStatusDisplay(); // í˜„ì¬ ìƒíƒœë¥¼ í™”ë©´ì— ì—…ë°ì´íŠ¸
            updateStatusButtons();       // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('teacherModal').classList.remove('hidden');
        }

        /**
         * ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œì˜ í˜„ì¬ ìƒíƒœ í‘œì‹œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateCurrentStatusDisplay() {
            const config = statusConfig[currentTeacher.status];
            document.getElementById('currentStatus').innerHTML = `
                ${config.icon} ${currentTeacher.status}
            `;
        }

        /**
         * ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œì—ì„œ í˜„ì¬ ìƒíƒœì— í•´ë‹¹í•˜ëŠ” ë²„íŠ¼ì„ í™œì„±í™”(í‘œì‹œ)í•©ë‹ˆë‹¤.
         */
        function updateStatusButtons() {
            const buttons = document.querySelectorAll('#teacherModal .status-btn'); // ì„ ìƒë‹˜ ëª¨ë‹¬ ë‚´ ë²„íŠ¼ë§Œ ì„ íƒ
            buttons.forEach(btn => {
                btn.classList.remove('active'); // ëª¨ë“  ë²„íŠ¼ì˜ í™œì„±í™” í´ë˜ìŠ¤ ì œê±°

                const buttonStatus = btn.getAttribute('data-status');
                if (currentTeacher.status === buttonStatus) {
                    btn.classList.add('active');
                }
            });
        }

        /**
         * ë¡œê·¸ì¸í•œ ì„ ìƒë‹˜ì˜ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ê³  Firebase Realtime Databaseì— ì €ì¥í•©ë‹ˆë‹¤.
         * @param {string} newStatus - ìƒˆë¡œ ì„¤ì •í•  ìƒíƒœ.
         */
        async function updateStatus(newStatus) {
            const teacherIndex = teachers.findIndex(t => t.name === currentTeacher.name);
            if (teacherIndex !== -1) {
                teachers[teacherIndex].status = newStatus; // ë¡œì»¬ teachers ë°°ì—´ì˜ ìƒíƒœ ì—…ë°ì´íŠ¸
                currentTeacher.status = newStatus;         // í˜„ì¬ ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ê°ì²´ì˜ ìƒíƒœë„ ì—…ë°ì´íŠ¸

                try {
                    await set(teachersRef, teachers);
                    console.log("ìƒíƒœ ì—…ë°ì´íŠ¸ ë° Firebase ì €ì¥ ì„±ê³µ", newStatus);
                    updateCurrentStatusDisplay(); // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    updateStatusButtons();       // ë²„íŠ¼ ìƒíƒœ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                } catch (error) {
                    console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ë° Firebase ì €ì¥ ì˜¤ë¥˜:", error);
                }
            } else {
                console.error("í˜„ì¬ ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì •ë³´ë¥¼ teachers ë°°ì—´ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", currentTeacher);
            }
        }

        /**
         * í˜„ì¬ ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì„ ë¡œê·¸ì•„ì›ƒí•˜ê³  ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ì„ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function logout() {
            currentTeacher = null; // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì •ë³´ ì´ˆê¸°í™”
            document.getElementById('teacherModal').classList.add('hidden');
            // ë³´ì•ˆì„ ìœ„í•´ ë¡œê·¸ì¸ í•„ë“œë„ ì´ˆê¸°í™”
            document.getElementById('loginName').value = '';
            document.getElementById('loginPassword').value = '';
            renderTeachers(); // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì¹´ë“œì— ì ìš©ëœ ìŠ¤íƒ€ì¼ ì œê±°ë¥¼ ìœ„í•´ ë‹¤ì‹œ ë Œë”ë§
            console.log("ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì— í´ë¦­ ë¦¬ìŠ¤ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."); // í™•ì¸ìš© ë¡œê·¸
        }

        // --- Q&A ê¸°ëŠ¥ ì¶”ê°€ ---

        /**
         * ISO í˜•ì‹ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ ì½ê¸° ì‰¬ìš´ ë¡œì»¬ ì‹œê°„ ë¬¸ìì—´ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
         * @param {string} isoTimestamp - ISO í˜•ì‹ì˜ íƒ€ì„ìŠ¤íƒ¬í”„ ë¬¸ìì—´.
         * @returns {string} í¬ë§·íŒ…ëœ ì‹œê°„ ë¬¸ìì—´.
         */
        function formatTimestamp(isoTimestamp) {
            if (!isoTimestamp) return 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            const date = new Date(isoTimestamp);
            // í•œêµ­ ì‹œê°„ëŒ€ë¡œ ì„¤ì •í•˜ì—¬ í¬ë§·íŒ…
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false, // 24ì‹œê°„ í˜•ì‹
                timeZone: 'Asia/Seoul'
            };
            return date.toLocaleString('ko-KR', options);
        }

        /**
         * í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ì„ í‘œì‹œí•©ë‹ˆë‹¤.
         * @param {object} teacher - ì§ˆë¬¸í•  ì„ ìƒë‹˜ ê°ì²´.
         */
        function showStudentQuestionModal(teacher) {
            selectedTeacherForQuestion = teacher;
            document.getElementById('questionTeacherName').textContent = `${teacher.name} ì„ ìƒë‹˜ê»˜ ì§ˆë¬¸í•˜ê¸°`;
            document.getElementById('studentId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('questionText').value = '';
            document.getElementById('questionError').classList.add('hidden');
            document.getElementById('studentQuestionModal').classList.remove('hidden');
            document.getElementById('studentId').focus();
            console.log("í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ í‘œì‹œ:", teacher.name); // í™•ì¸ìš© ë¡œê·¸
        }

        /**
         * í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ì„ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function hideStudentQuestionModal() {
            selectedTeacherForQuestion = null;
            document.getElementById('studentQuestionModal').classList.add('hidden');
            console.log("í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ ìˆ¨ê¹€"); // í™•ì¸ìš© ë¡œê·¸
        }

        /**
         * í•™ìƒ ì§ˆë¬¸ì„ Firebaseì— ì €ì¥í•©ë‹ˆë‹¤.
         * @param {Event} event - í¼ ì œì¶œ ì´ë²¤íŠ¸ ê°ì²´.
         */
        async function handleQuestionSubmission(event) {
            event.preventDefault();

            const studentId = document.getElementById('studentId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const questionText = document.getElementById('questionText').value.trim();
            const errorDiv = document.getElementById('questionError');

            if (!studentId || !studentName || !questionText) {
                errorDiv.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                errorDiv.classList.remove('hidden');
                return;
            }

            // ì„ íƒëœ ì„ ìƒë‹˜ì˜ ì¸ë±ìŠ¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            const teacherIndex = teachers.findIndex(t => t.name === selectedTeacherForQuestion.name);

            if (teacherIndex !== -1) {
                // messages ë°°ì—´ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™” (Firebase ë°ì´í„°ê°€ ë°°ì—´ì´ ì•„ë‹Œ ê°ì²´ë¡œ ì˜¬ ê²½ìš° ëŒ€ë¹„)
                if (!teachers[teacherIndex].messages) {
                    teachers[teacherIndex].messages = [];
                }

                const newMessage = {
                    id: Date.now().toString(), // ê°„ë‹¨í•œ ê³ ìœ  ID (timestamp ê¸°ë°˜)
                    studentId: studentId,
                    studentName: studentName,
                    question: questionText,
                    questionTimestamp: new Date().toISOString(), // ISO í˜•ì‹ìœ¼ë¡œ ì €ì¥
                    teacherReply: "",
                    replyTimestamp: ""
                };

                teachers[teacherIndex].messages.push(newMessage);

                try {
                    await set(teachersRef, teachers); // ì „ì²´ teachers ë°°ì—´ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                    console.log("í•™ìƒ ì§ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.", newMessage);
                    hideStudentQuestionModal();
                    alert("ì§ˆë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (error) {
                    console.error("ì§ˆë¬¸ ì œì¶œ ì˜¤ë¥˜:", error);
                    errorDiv.textContent = 'ì§ˆë¬¸ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    errorDiv.classList.remove('hidden');
                }
            } else {
                errorDiv.textContent = 'ì„ íƒëœ ì„ ìƒë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                errorDiv.classList.remove('hidden');
            }
        }

        /**
         * ì„ ìƒë‹˜ Q&A ëª¨ë‹¬ì„ í‘œì‹œí•˜ê³  í•´ë‹¹ ì„ ìƒë‹˜ì˜ ì§ˆë¬¸ ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         */
        function showTeacherQAModal() {
            if (!currentTeacher) return; // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì´ ì—†ìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ

            document.getElementById('qaTeacherName').textContent = `${currentTeacher.name} ì„ ìƒë‹˜ì˜ ì§ˆë¬¸ ê´€ë¦¬`;
            renderTeacherQuestions(currentTeacher.messages || []); // ë©”ì‹œì§€ê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ ì „ë‹¬
            document.getElementById('teacherQAModal').classList.remove('hidden');
            // ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ì€ ìˆ¨ê¹ë‹ˆë‹¤.
            document.getElementById('teacherModal').classList.add('hidden');
            console.log("ì„ ìƒë‹˜ Q&A ëª¨ë‹¬ í‘œì‹œ"); // í™•ì¸ìš© ë¡œê·¸
        }

        /**
         * ì„ ìƒë‹˜ Q&A ëª¨ë‹¬ì„ ìˆ¨ê¹ë‹ˆë‹¤.
         */
        function hideTeacherQAModal() {
            document.getElementById('teacherQAModal').classList.add('hidden');
            // Q&A ëª¨ë‹¬ì„ ë‹«ìœ¼ë©´ ë‹¤ì‹œ ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
            if (currentTeacher) {
                showTeacherDashboard();
            }
            console.log("ì„ ìƒë‹˜ Q&A ëª¨ë‹¬ ìˆ¨ê¹€"); // í™•ì¸ìš© ë¡œê·¸
        }

        /**
         * í˜„ì¬ ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì˜ ì§ˆë¬¸ ëª©ë¡ì„ ë Œë”ë§í•©ë‹ˆë‹¤.
         * @param {Array} messages - ì„ ìƒë‹˜ì˜ ë©”ì‹œì§€ ë°°ì—´.
         */
        function renderTeacherQuestions(messages) {
            const questionsListDiv = document.getElementById('teacherQuestionsList');
            questionsListDiv.innerHTML = ''; // ì´ì „ ì§ˆë¬¸ ì§€ìš°ê¸°

            if (!messages || messages.length === 0) {
                questionsListDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 1rem;">ì•„ì§ ë„ì°©í•œ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // ìµœì‹  ì§ˆë¬¸ì´ ìœ„ë¡œ ì˜¤ë„ë¡ ì§ˆë¬¸ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì—­ìˆœ ì •ë ¬
            const sortedMessages = [...messages].sort((a, b) => new Date(b.questionTimestamp) - new Date(a.questionTimestamp));

            sortedMessages.forEach((message, index) => {
                // ì›ë³¸ `messages` ë°°ì—´ì—ì„œ í˜„ì¬ `message`ì˜ ì •í™•í•œ ì¸ë±ìŠ¤ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
                // ì´ëŠ” `set` í•¨ìˆ˜ë¡œ ì „ì²´ ë°°ì—´ì„ ì—…ë°ì´íŠ¸í•  ë•Œ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì°¾ì•„ì•¼ í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
                const originalIndex = messages.findIndex(msg => msg.id === message.id);
                if (originalIndex === -1) {
                    console.error("ì›ë³¸ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Q&A ë°ì´í„° ë¶ˆì¼ì¹˜ ê°€ëŠ¥ì„±:", message);
                    return;
                }

                const messageCard = document.createElement('div');
                messageCard.className = 'teacher-card';
                messageCard.style.marginBottom = '1rem';
                messageCard.style.padding = '1rem';
                messageCard.style.boxShadow = 'none';
                messageCard.style.border = '1px solid #e5e7eb';
                // ë‹µë³€ ì—¬ë¶€ì— ë”°ë¼ ë°°ê²½ìƒ‰ ë‹¤ë¥´ê²Œ í‘œì‹œ
                messageCard.style.backgroundColor = message.teacherReply ? '#f9fafb' : '#fff7ed';

                messageCard.innerHTML = `
                    <p style="font-weight: bold; color: #1f2937;">${message.studentName} (${message.studentId})</p>
                    <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem;">ì§ˆë¬¸ ì‹œê°„: ${formatTimestamp(message.questionTimestamp)}</p>
                    <p style="margin-bottom: 1rem;">${message.question}</p>
                    ${message.teacherReply ? `
                        <p style="font-weight: bold; color: #3b82f6;">ë‹µë³€:</p>
                        <p style="margin-bottom: 0.5rem;">${message.teacherReply}</p>
                        <p style="color: #6b7280; font-size: 0.85rem;">ë‹µë³€ ì‹œê°„: ${formatTimestamp(message.replyTimestamp)}</p>
                    ` : `
                        <textarea class="form-input teacher-reply-input" rows="3" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”" data-message-original-index="${originalIndex}"></textarea>
                        <button class="btn btn-primary reply-btn" data-message-original-index="${originalIndex}" style="margin-top: 0.5rem; width: 100%;">ë‹µë³€ ì œì¶œ</button>
                    `}
                `;
                questionsListDiv.appendChild(messageCard);
            });

            // ë‹µë³€ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            questionsListDiv.querySelectorAll('.reply-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const originalIndex = parseInt(event.target.getAttribute('data-message-original-index'));
                    const replyInput = questionsListDiv.querySelector(`.teacher-reply-input[data-message-original-index="${originalIndex}"]`);
                    if (replyInput && replyInput.value.trim()) {
                        handleTeacherReply(originalIndex, replyInput.value.trim());
                    } else {
                        alert('ë‹µë³€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                });
            });
            console.log("ì„ ìƒë‹˜ ì§ˆë¬¸ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ"); // í™•ì¸ìš© ë¡œê·¸
        }

        /**
         * êµì‚¬ì˜ ë‹µë³€ì„ Firebaseì— ì €ì¥í•©ë‹ˆë‹¤.
         * @param {number} originalMessageIndex - ë‹µë³€í•  ë©”ì‹œì§€ì˜ teachers ë°°ì—´ ë‚´ ì›ë³¸ ì¸ë±ìŠ¤.
         * @param {string} replyText - êµì‚¬ì˜ ë‹µë³€ ë‚´ìš©.
         */
        async function handleTeacherReply(originalMessageIndex, replyText) {
            if (!currentTeacher) return;

            const teacherIndex = teachers.findIndex(t => t.name === currentTeacher.name);
            if (teacherIndex !== -1 && teachers[teacherIndex].messages && teachers[teacherIndex].messages[originalMessageIndex]) {
                // ì›ë³¸ ë°°ì—´ì˜ í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
                teachers[teacherIndex].messages[originalMessageIndex].teacherReply = replyText;
                teachers[teacherIndex].messages[originalMessageIndex].replyTimestamp = new Date().toISOString();

                try {
                    await set(teachersRef, teachers); // ì „ì²´ teachers ë°°ì—´ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                    console.log("êµì‚¬ ë‹µë³€ì´ ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    // onValue ë¦¬ìŠ¤ë„ˆë¥¼ í†µí•´ UIê°€ ìë™ìœ¼ë¡œ ì¬ë Œë”ë§ë˜ë¯€ë¡œ, ë³„ë„ì˜ render í˜¸ì¶œì€ í•„ìš” ì—†ìŒ.
                } catch (error) {
                    console.error("êµì‚¬ ë‹µë³€ ì œì¶œ ì˜¤ë¥˜:", error);
                    alert("ë‹µë³€ ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            } else {
                console.error("ë‹µë³€í•  ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }


        // --- ì´ˆê¸° ë¡œë“œ ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---

        document.addEventListener('DOMContentLoaded', () => {
            // í˜ì´ì§€ ë¡œë“œ ì‹œ Firebase ë°ì´í„° ë¦¬ìŠ¤ë„ˆë¥¼ ì„¤ì •í•˜ì—¬ ì‹¤ì‹œê°„ ë™ê¸°í™”ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.
            initializeFirebaseDataListener();

            // ë¡œê·¸ì¸ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const loginButton = document.getElementById('loginButton');
            if (loginButton) {
                loginButton.addEventListener('click', showLogin);
            }

            // ë¡œê·¸ì¸ í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }

            // ë¡œê·¸ì¸ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const loginCancelBtn = document.getElementById('loginCancelBtn');
            if (loginCancelBtn) {
                loginCancelBtn.addEventListener('click', hideLogin);
            }

            // Enter í‚¤ ì…ë ¥ ì‹œ ë¡œê·¸ì¸ ì²˜ë¦¬ (í˜„ì¬ ë¡œê·¸ì¸ ëª¨ë‹¬ì´ ì—´ë ¤ ìˆì„ ë•Œë§Œ)
            document.addEventListener('keydown', function(event) {
                const loginModal = document.getElementById('loginModal');
                if (event.key === 'Enter' && !loginModal.classList.contains('hidden')) {
                    loginForm.dispatchEvent(new Event('submit'));
                }
            });

            // ìƒíƒœ ë³€ê²½ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const statusButtons = document.querySelectorAll('#teacherModal .status-btn');
            statusButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const newStatus = btn.getAttribute('data-status');
                    if (newStatus) {
                        updateStatus(newStatus);
                    } else {
                        console.warn("ìƒíƒœ ë³€ê²½ ë²„íŠ¼ì— 'data-status' ì†ì„±ì´ ì—†ìŠµë‹ˆë‹¤:", btn);
                    }
                });
            });

            // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const logoutButton = document.getElementById('logoutBtn');
            if (logoutButton) {
                logoutButton.addEventListener('click', logout);
            }

            // --- Q&A ê¸°ëŠ¥ ê´€ë ¨ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

            // ì„ ìƒë‹˜ ì¹´ë“œ í´ë¦­ ì‹œ í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ ì—´ê¸° (í•™ìƒìš©)
            const teachersGrid = document.getElementById('teachersGrid');
            if (teachersGrid) {
                teachersGrid.addEventListener('click', (event) => {
                    const teacherCard = event.target.closest('.teacher-card');
                    if (teacherCard) {
                        // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì¹´ë“œëŠ” í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë¬´ì‹œ (ë˜ëŠ” ë‹¤ë¥¸ ê¸°ëŠ¥ ë¶€ì—¬)
                        if (teacherCard.classList.contains('logged-in-teacher')) {
                            console.log("ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì¹´ë“œëŠ” í•™ìƒ ì§ˆë¬¸ì„ íŠ¸ë¦¬ê±°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                            return; // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ ì¹´ë“œëŠ” ì—¬ê¸°ì„œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
                        }

                        const teacherNameElement = teacherCard.querySelector('.teacher-name');
                        if (teacherNameElement) {
                            const clickedTeacherName = teacherNameElement.textContent;
                            const teacher = teachers.find(t => t.name === clickedTeacherName);
                            // ë¡œê·¸ì¸ëœ ì„ ìƒë‹˜ì´ ì—†ì„ ë•Œë§Œ í•™ìƒ ì§ˆë¬¸ í—ˆìš©
                            if (teacher && !currentTeacher) {
                                showStudentQuestionModal(teacher);
                            } else if (currentTeacher) {
                                console.log("ì„ ìƒë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì–´ ìˆì–´ í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            } else {
                                console.log("í´ë¦­í•œ ì„ ìƒë‹˜ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                            }
                        }
                    }
                });
            }

            // í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ í¼ ì œì¶œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const questionForm = document.getElementById('questionForm');
            if (questionForm) {
                questionForm.addEventListener('submit', handleQuestionSubmission);
            }

            // í•™ìƒ ì§ˆë¬¸ ëª¨ë‹¬ ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const questionCancelBtn = document.getElementById('questionCancelBtn');
            if (questionCancelBtn) {
                questionCancelBtn.addEventListener('click', hideStudentQuestionModal);
            }

            // ì„ ìƒë‹˜ ëŒ€ì‹œë³´ë“œ ë‚´ "ì§ˆë¬¸ ë‹µë³€ ê´€ë¦¬" ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const openQAModalBtn = document.getElementById('openQAModalBtn');
            if (openQAModalBtn) {
                openQAModalBtn.addEventListener('click', showTeacherQAModal);
            }

            // ì„ ìƒë‹˜ Q&A ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const closeQAModalBtn = document.getElementById('closeQAModalBtn');
            if (closeQAModalBtn) {
                closeQAModalBtn.addEventListener('click', hideTeacherQAModal);
            }
        });
    </script>
</body>
</html>
